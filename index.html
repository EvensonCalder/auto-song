<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evenson Last.fm 听歌记录分析</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .section-title {
            margin-bottom: 15px;
            color: #3498db;
            font-size: 1.2rem;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .random-result {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            min-height: 50px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .ranking-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .ranking-table th, .ranking-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .ranking-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .ranking-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #7f8c8d;
        }
        
        .random-result ul {
            padding-left: 1.5em;
            margin: 0;
            list-style-position: inside;
        }

        .random-result li {
            margin-bottom: 5px;
            text-indent: -1.2em;
            padding-left: 1.2em;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                width: 100%;
            }
            
            .ranking-table {
                font-size: 0.9rem;
            }
            
            .ranking-table th, .ranking-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <h1>Evenson Last.fm 听歌记录分析</h1>
    
    <div class="container">
        <div class="section">
            <h2 class="section-title">时间范围选择</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="start-date">开始日期</label>
                    <input type="date" id="start-date">
                </div>
                <div class="control-group">
                    <label for="end-date">结束日期</label>
                    <input type="date" id="end-date">
                </div>
                <div class="control-group">
                    <label style="visibility: hidden;">应用筛选</label>
                    <button id="apply-filter">应用筛选</button>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">随机选歌</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="random-count">选择数量</label>
                    <select id="random-count">
                        <option value="1">1 首</option>
                        <option value="5">5 首</option>
                        <option value="10">10 首</option>
                    </select>
                </div>
                <div class="control-group">
                    <label style="visibility: hidden;">随机选取</label>
                    <button id="random-select">随机选取</button>
                </div>
            </div>
            <div class="random-result" id="random-result"></div>
        </div>
        
        <div class="section">
            <h2 class="section-title">排行榜</h2>
            <div class="ranking-controls">
                <select id="ranking-type">
                    <option value="song">歌曲排行榜</option>
                    <option value="artist">艺人排行榜</option>
                    <option value="album">专辑排行榜</option>
                </select>
                <button id="prev-page">上一页</button>
                <button id="next-page">下一页</button>
            </div>
            <div id="ranking-container">
                <div class="loading">加载中...</div>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">星期分布</h2>
            <div class="chart-container">
                <canvas id="day-of-week-chart"></canvas>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">24小时分布</h2>
            <div class="chart-container">
                <canvas id="hour-of-day-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // 初始化变量
        let allRecords = [];
        let filteredRecords = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let dayOfWeekChart, hourOfDayChart;
        
        // 星期名称映射
        const dayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
        
        // 设置默认日期范围（今天之前的5000天到今天）
        function setDefaultDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 5000);
            
            document.getElementById('start-date').valueAsDate = startDate;
            document.getElementById('end-date').valueAsDate = endDate;
        }
        
        // 从GitHub获取CSV数据
        async function fetchData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/EvensonCalder/auto-song/main/proevenson.csv');
                const csvData = await response.text();
                
                // 使用PapaParse解析CSV
                Papa.parse(csvData, {
                    header: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allRecords = results.data.map(row => {
                            // 处理日期格式
                            const dateStr = row[3];
                            const date = new Date(dateStr);
                            
                            return {
                                artist: row[0],
                                album: row[1],
                                song: row[2],
                                timestamp: date,
                                date: dateStr,
                                dayOfWeek: date.getDay(),
                                hourOfDay: date.getHours()
                            };
                        });
                        
                        // 应用默认日期范围
                        filterRecords();
                        updateAllVisualizations();
                    }
                });
            } catch (error) {
                console.error('获取数据时出错:', error);
                alert('获取数据时出错，请检查控制台获取详细信息。');
            }
        }
        
        // 根据日期范围筛选记录
        function filterRecords() {
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);
            endDate.setHours(23, 59, 59, 999); // 包含结束日期的全天
            
            filteredRecords = allRecords.filter(record => {
                return record.timestamp >= startDate && record.timestamp <= endDate;
            });
        }
        
        // 更新所有可视化组件
        function updateAllVisualizations() {
            updateRankings();
            updateCharts();
        }
        
        // 更新排行榜
        function updateRankings() {
            const rankingType = document.getElementById('ranking-type').value;
            const container = document.getElementById('ranking-container');
            
            // 计算不同实体的播放次数
            let counts = {};
            filteredRecords.forEach(record => {
                const key = record[rankingType];
                counts[key] = (counts[key] || 0) + 1;
            });
            
            // 转换为数组并排序
            const sorted = Object.entries(counts)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count);
            
            // 分页
            const totalPages = Math.ceil(sorted.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedItems = sorted.slice(startIndex, startIndex + itemsPerPage);
            
            // 生成表格HTML
            let html = `
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>${rankingType === 'song' ? '歌曲' : rankingType === 'artist' ? '艺人' : '专辑'}</th>
                            <th>播放次数</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            paginatedItems.forEach((item, index) => {
                const rank = startIndex + index + 1;
                html += `
                    <tr>
                        <td>${rank}</td>
                        <td>${item.name}</td>
                        <td>${item.count}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div class="pagination">
                    第 ${currentPage} 页，共 ${totalPages} 页
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // 更新图表
        function updateCharts() {
            updateDayOfWeekChart();
            updateHourOfDayChart();
        }
        
        // 更新星期分布图表
        function updateDayOfWeekChart() {
            const ctx = document.getElementById('day-of-week-chart').getContext('2d');
            
            // 计算每天的数量
            const dayCounts = Array(7).fill(0);
            filteredRecords.forEach(record => {
                dayCounts[record.dayOfWeek]++;
            });
            
            // 准备图表数据
            const data = dayCounts.map((count, index) => ({
                day: dayNames[index],
                count: count
            }));
            
            // 销毁旧图表（如果存在）
            if (dayOfWeekChart) {
                dayOfWeekChart.destroy();
            }
            
            // 创建新图表
            dayOfWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.day),
                    datasets: [{
                        label: '播放次数',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `播放次数: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 更新24小时分布图表
        function updateHourOfDayChart() {
            const ctx = document.getElementById('hour-of-day-chart').getContext('2d');
            
            // 计算每小时的数量
            const hourCounts = Array(24).fill(0);
            filteredRecords.forEach(record => {
                hourCounts[record.hourOfDay]++;
            });
            
            // 准备图表数据
            const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
            const data = hourCounts;
            
            // 销毁旧图表（如果存在）
            if (hourOfDayChart) {
                hourOfDayChart.destroy();
            }
            
            // 创建新图表
            hourOfDayChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '播放次数',
                        data: data,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `播放次数: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 随机选择歌曲
        function selectRandomSongs() {
            const count = parseInt(document.getElementById('random-count').value);
            const resultContainer = document.getElementById('random-result');
            
            if (filteredRecords.length === 0) {
                resultContainer.innerHTML = '没有可用的记录。';
                return;
            }
            
            // 随机选择不重复的歌曲
            const shuffled = [...filteredRecords].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, Math.min(count, shuffled.length));
            
            // 显示结果
            let html = '<ul>';
            selected.forEach(record => {
                html += `<li>${record.artist} - ${record.song} (${record.album}) - ${record.date}</li>`;
            });
            html += '</ul>';
            
            resultContainer.innerHTML = html;
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            document.getElementById('apply-filter').addEventListener('click', function() {
                filterRecords();
                updateAllVisualizations();
            });
            
            document.getElementById('random-select').addEventListener('click', selectRandomSongs);
            
            document.getElementById('ranking-type').addEventListener('change', function() {
                currentPage = 1;
                updateRankings();
            });
            
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    updateRankings();
                }
            });
            
            document.getElementById('next-page').addEventListener('click', function() {
                // 简单估算最大页数
                const rankingType = document.getElementById('ranking-type').value;
                let counts = {};
                filteredRecords.forEach(record => {
                    const key = record[rankingType];
                    counts[key] = (counts[key] || 0) + 1;
                });
                
                const totalPages = Math.ceil(Object.keys(counts).length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateRankings();
                }
            });
        }
        
        // 初始化应用
        function initApp() {
            setDefaultDateRange();
            initEventListeners();
            fetchData();
        }
        
        // 当页面加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
